/// Environment is environment for building and running user functions.
///
/// This module was generated from the CustomResourceDefinition at
/// <file:///Users/lucsoft/Developer/infra-hmsys-sys/packages/io.Fission/>.
module io.fission.v1.Environment

extends "@k8s/K8sResource.pkl"

import "@k8s/apimachinery/pkg/apis/meta/v1/ObjectMeta.pkl"
import "@k8s/api/core/v1/PodSpec.pkl"

fixed apiVersion: "fission.io/v1"

fixed kind: "Environment"

/// Standard object's metadata.
///
/// More info: <https://git.k8s.io/community/contributors/devel/sig-architecture/api-conventions.md#metadata>.
metadata: ObjectMeta?

/// EnvironmentSpec contains with builder, runtime and some other related environment settings.
spec: Spec

/// EnvironmentSpec contains with builder, runtime and some other related environment settings.
class Spec {
  /// Istio default blocks all egress traffic for safety. To enable accessibility of external network for
  /// builder/function pod, set to 'true'. (Optional) defaults to 'false'
  allowAccessToExternalNetwork: Boolean?

  /// (Optional) defaults to 'single'. Fission workflow uses 'infinite' to load multiple functions in one
  /// function pod. Available value: - single - infinite
  allowedFunctionsPerContainer: String?

  /// (Optional) Builder is configuration for builder manager to launch environment builder to build
  /// source code into deployable binary.
  builder: Builder?

  /// ImagePullSecret is the secret for Kubernetes to pull an image from a private registry.
  imagepullsecret: String?

  /// KeepArchive is used by fetcher to determine if the extracted archive or unarchived file should be
  /// placed, which is then used by specialize handler. (This is mainly for the JVM environment because
  /// .jar is one kind of zip archive.)
  keeparchive: Boolean?

  /// The initial pool size for environment
  poolsize: Int?

  /// The request and limit CPU/MEM resource setting for poolmanager to set up pods in the pre-warm pool.
  /// (Optional) defaults to no limitation.
  resources: Resources?

  /// Runtime is configuration for running function, like container image etc.
  runtime: Runtime

  /// The grace time for pod to perform connection draining before termination. The unit is in seconds.
  /// (Optional) defaults to 360 seconds
  terminationGracePeriod: Int?

  /// Version is the Environment API version
  ///
  /// Version "1" allows user to run code snippet in a file, and it's supported by most of the
  /// environments except tensorflow-serving.
  ///
  /// Version "2" supports downloading and compiling user function if source archive is not empty.
  ///
  /// Version "3" is almost the same with v2, but you're able to control the size of pre-warm pool of the
  /// environment.
  version: Int
}

/// (Optional) Builder is configuration for builder manager to launch environment builder to build source
/// code into deployable binary.
class Builder {
  /// (Optional) Default build command to run for this build environment.
  command: String?

  /// (Optional) Container allows the modification of the deployed builder container using the Kubernetes
  /// Container spec. Fission overrides the following fields: - Name - Image; set to the Builder.Image -
  /// Command; set to the Builder.Command - TerminationMessagePath - ImagePullPolicy - ReadinessProbe
  container: PodSpec.Container?

  /// Image for containing the language compilation environment.
  image: String?

  /// PodSpec will store the spec of the pod that will be applied to the pod created for the builder
  podspec: PodSpec?
}

/// The request and limit CPU/MEM resource setting for poolmanager to set up pods in the pre-warm pool.
/// (Optional) defaults to no limitation.
class Resources {
  /// Claims lists the names of resources, defined in spec.resourceClaims, that are used by this
  /// container.
  ///
  /// This field depends on the DynamicResourceAllocation feature gate.
  ///
  /// This field is immutable. It can only be set for containers.
  claims: Listing<Claim>?

  /// Limits describes the maximum amount of compute resources allowed. More info:
  /// https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
  limits: Mapping<String, Int|String>?

  /// Requests describes the minimum amount of compute resources required. If Requests is omitted for a
  /// container, it defaults to Limits if that is explicitly specified, otherwise to an
  /// implementation-defined value. Requests cannot exceed Limits. More info:
  /// https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/
  requests: Mapping<String, Int|String>?
}

/// ResourceClaim references one entry in PodSpec.ResourceClaims.
class Claim {
  /// Name must match the name of one entry in pod.spec.resourceClaims of the Pod where this field is
  /// used. It makes that resource available inside a container.
  name: String

  /// Request is the name chosen for a request in the referenced claim. If empty, everything from the
  /// claim is made available, otherwise only the result of this request.
  request: String?
}

/// Runtime is configuration for running function, like container image etc.
class Runtime {
  /// (Optional) Container allows the modification of the deployed runtime container using the Kubernetes
  /// Container spec. Fission overrides the following fields: - Name - Image; set to the Runtime.Image -
  /// TerminationMessagePath - ImagePullPolicy
  ///
  /// You can set either PodSpec or Container, but not both.
  /// kubebuilder:validation:XPreserveUnknownFields=true
  container: PodSpec.Container?

  /// Image for containing the language runtime.
  image: String

  /// (Optional) Podspec allows modification of deployed runtime pod with Kubernetes PodSpec The merging
  /// logic is briefly described below and detailed MergePodSpec function - Volumes mounts and env
  /// variables for function and fetcher container are appended - All additional containers and init
  /// containers are appended - Volume definitions are appended - Lists such as tolerations,
  /// ImagePullSecrets, HostAliases are appended - Structs are merged and variables from pod spec take
  /// precedence
  ///
  /// You can set either PodSpec or Container, but not both.
  podspec: PodSpec?
}
