module App

import "./Application.pkl"

name = "app"

local app = this

autoSync = true

destination: Application.Destination = new {
  name = "in-cluster"
  namespace = app.namespace
}

ignoreDifferences: Listing<Application.ComparedToIgnoreDifference>? = null

project = "default"

namespace = "default"

source: Application.SpecSource?

sources: Listing<Application.ComparedToSource>?

application: Application = new {
  metadata {
    name = app.name
    namespace = "argocd"
    annotations {
      ["argocd.argoproj.io/compare-options"] = "ServerSideDiff=true"
    }
  }
  spec {
    syncPolicy {
      when (app.autoSync == true) {
        automated {
          prune = true
          selfHeal = true
        }
      }
      syncOptions {
        when (ignoreDifferences != null) {
          "RespectIgnoreDifferences=true"
        }
        "ApplyOutOfSyncOnly=true"
        "AutoCreateNamespace=true"
        "ServerSideApply=true"
      }
    }
    project = app.project
    destination = app.destination
    ignoreDifferences = app.ignoreDifferences
    source = app.source
    sources = app.sources
  }
}
